# Bazel query

- [Bazel query](#bazel-query)
  - [Query for a macro](#query-for-a-macro)
  - [Run a Query Output](#run-a-query-output)
  - [Generating a dependency tree out of a query](#generating-a-dependency-tree-out-of-a-query)
    - [Finding all target that depend on a other target](#finding-all-target-that-depend-on-a-other-target)

The bazel query is used to query the dependency tree. The reference on the syntax of the query language can be found [here][1].

## Query for a macro

If you want to find all targets that are generated by the following Starlark macro.

```bash
bazel query "attr(generator_function, <macro-name>, //...)"
```

## Run a Query Output

If you want to run the result of a query with a build or test you can leverage the `xargs`.
This will pass the output to the `bazel test` or `build`.

```bash
bazel query "attr(generator_function, <macro-name>, //...)" | xargs bazel test
```

## Generating a dependency tree out of a query

Every query supports outputting a graph by passing the `--output graph` arguments to the query. The result can be piped by the dot package to an svg format.
So there are no limits on which parts to display or query. 

```bash
bazel query "attr(generator_function, ng_module_view_engine, //...)" --output graph | dot -Tsvg > dep-graph.svg
```

### Finding all target that depend on a other target

For example if you want to check wich targets in your codebase depend on a specific package you can create this query to showcase where you depend on it.
This query would list all targets in the workspace that depend on the `@angular/cdk` package.

```bash
bazel query "allpaths(//..., @npm//@angular/cdk)" --notool_deps --output graph | dot -Tsvg > ./cdk-deps.svg
```

or if you want to get rid of the `lodash-es` dependency for example you can find all occurances

```bash
bazel query 'allpaths(//libs/barista-components/..., @npm//lodash-es)'
//libs/barista-components/chart:test
//libs/barista-components/chart:test_compile
//libs/barista-components/chart:compile
@npm//lodash-es:lodash-es
Loading: 0 packages loaded
```


[1]: https://docs.bazel.build/versions/master/query.html "Bazel query language"