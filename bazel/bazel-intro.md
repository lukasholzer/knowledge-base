# Bazel Intro

- [Bazel Intro](#bazel-intro)
  - [What is Bazel actually](#what-is-bazel-actually)
  - [The fundamentals of a Bazel build](#the-fundamentals-of-a-bazel-build)
    - [Workspace](#workspace)
    - [Repositories](#repositories)
    - [Packages](#packages)
    - [Targets](#targets)
    - [Rules](#rules)
    - [Labels](#labels)
      - [Root of a label](#root-of-a-label)
      - [Traversing packages](#traversing-packages)
      - [Specifying targets](#specifying-targets)
  - [Authoring Bazel Builds](#authoring-bazel-builds)

## What is Bazel actually

Bazel is a build tool developed and used by Google. It is language agnostic per design. The core functionality is to provide *incremental* and *hermetic* builds.

Incremental: Code does not need to be rebuilt every time. As soon as a defined part of the system is built, it only has to be rebuilt if it changes.

Hermetic: The build will deliver the same results for the same input every time. Any factors outside of the build system are not influencing the build (OS, Java version etc.).

## The fundamentals of a Bazel build

### Workspace

Bazel builds consist of workspaces. Usually one project has one single workspace only. Everything that happens in a Bazel builds is within the workspace, the workspace defines a clear border to what is managed by Bazel.

The root of a workspace is marked by a file called *WORKSPACE*. Every sub folder is part of the workspace.

The WORKSPACE file contains:
    + The name of the workspace
    + The definition of the main repository (TODO link repos locally)
    + References to third party rules (TODO: Link to rules) and definitions of third party repositories (TODO Link to repo section)
    + Init actions to setup the workspace (setup toolchains for builds)

**Further reading: [The Bazel Docs](https://docs.bazel.build/versions/3.4.0/build-ref.html#workspace)**

### Repositories

Code is organized in repositories. The root of the workspace marks the root of the so called 'main repository'. There are also third party repositories that can be referenced.

**Further reading: [The Bazel Docs](https://docs.bazel.build/versions/3.4.0/build-ref.html#workspace)**

### Packages

The main building blocks of a Bazel build are called *Packages*
Packages must reside in a Workspace. Packages are effectively a group of files that logically belong together (Angular module for example) throughout multiple sub folders. Every package is marked by a file called BUILD.bazel or BUILD.bzl. Every package can contain multiple targets (TODO link to targets section locally)

**Further reading: [The Bazel Docs](https://docs.bazel.build/versions/3.4.0/build-ref.html#packages)**

### Targets

When packages are containers then targets are the elements within the container. Generally there are two kinds of targets:
**Files:** A handle to files in the workspace, can either be static or generated by Bazel
**Rules:** Actions to transform input to output (TODO link to rules section)
Examples of typical targets are: Compile, Test, Assemble, Lint

Targets do only point to files of the surrounding package and are referenced via the package it is located in.

**Further reading: [The Bazel Docs](https://docs.bazel.build/versions/3.4.0/build-ref.html#targets)**

### Rules

Rules are essentially functions that transform a definite input into output. For example compiling a Typescript file into a Javascript file based on a Typescript config file. The inputs are the \*.ts source files as well as a tsconfig.json, the rule implementation is 'compile typescript' and the output would be the compiled \*.js files.

Rules contain the concrete actions to be executed during a build. You can also write your own rules (TODO: Link to writing rules locally)

There are multiple types of build rules:

Binary rules: Builds some sort of executables that can later be executed using `bazel run`

Test rules: Are a special kind of binary rules

Library rules: This kind of rules is to compile/build software modules 

**Further reading: [The Bazel Docs](https://docs.bazel.build/versions/3.4.0/build-ref.html#rules)**

### Labels

Labels are used to invoke and reference targets. They are a piece of Bazel specific syntax that is briefly explained below.

Let's look at the following label:

```python
//libraries/components/button:compile
```

Now let's take a look at it part by part:

#### Root of a label

```python
//
```

The double slash references the local repository root that is specified in the WORKSPACE file of the project. An alternative would the following:

```python
@myproject//
```

You can explicitly state the name of your workspace name using '@'

Third party repositories are also referenced this way, for example:

```python
@bazel_tools//...
```

This references to a third party repository called 'bazel_tools'

#### Traversing packages

You can traverse through packages as you would traverse folders in a Linux filesystem. Actually the packages do represent the structure of the project as the packages are marked by BUILD.bazel files directly at the sources.

```python
//libraries/components/button
```

represents the following folder structure:

```shell
WORKSPACE
|- libraries
    |- components
        |- button
           BUILD.bazel
```

#### Specifying targets

The target name in a package is specified in combination with a delimiter (:)
See the example:

```python
//libraries/components/button:compile
```

This would invoke the compile target in the button package.

If you want to reference a target that is in the current package you can simply use `:compile`

**Further reading: [The Bazel Docs](https://docs.bazel.build/versions/3.4.0/build-ref.html#labels)**

## Authoring Bazel Builds

As mentioned above, every Bazel package has its according BUILD.bazel file. This section is dedicated to authoring such BUILD files as they are the essential parts of every Bazel build. Bazel builds are authored using Starlark which is a subset of Python. 

### Imports

In order to use rules you need to import them into your package. This is done via the load statement:

```python
load("//foo/bar:file.bzl", "some_rule", "some_other_rule")
```
 You can import from the local repository as well as third party repositories using the label notation.


 ### Dependencies

 Dependencies are fundamental elements of every Bazel build. Please do carefully read the official Bazel docs regarding dependencies:

**[The Bazel Docs explaining Dependencies](https://docs.bazel.build/versions/3.4.0/build-ref.html#dependencies)**

